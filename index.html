<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi App ‚Äì Mapov√° verzia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.5/dist/leaflet.css" />
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f2f2f2; margin:0; padding:10px; }
h1 { text-align:center; }
.card { background:white; padding:10px 15px; border-radius:12px; margin-bottom:15px; }
label { font-weight:600; display:block; margin-top:10px; }
input, select { width:100%; padding:10px; font-size:16px; margin-top:5px; }
.result { font-size:18px; margin-top:10px; font-weight:bold; }
.green { color:green; }
.red { color:red; }
#map { height:300px; border-radius:12px; margin-top:10px; }
.hidden { display:none; }
</style>
</head>
<body>

<h1>üöï Taxi aplik√°cia ‚Äì Mapov√° verzia</h1>

<div class="card">
  <label>Re≈æim aplik√°cie</label>
  <select id="mode">
    <option value="costs">Kalkulaƒçka n√°kladov</option>
    <option value="taximeter">Taxameter</option>
  </select>
</div>

<!-- Blok vstupov -->
<div id="inputs" class="card">
  <label>Poloha vozidla (GPS)</label>
  <input type="text" id="vehiclePos" readonly placeholder="Naƒç√≠tanie GPS...">

  <label>N√°stup klienta</label>
  <input type="text" id="startAddress" placeholder="Zadaj adresu alebo klikni na mapu">

  <label>Cieƒæ klienta</label>
  <input type="text" id="endAddress" placeholder="Zadaj adresu alebo klikni na mapu">

  <label>Pr√≠platky</label>
  <input type="number" id="extras" value="0" step="0.1">
</div>

<div id="map"></div>

<div id="results" class="card result">V√Ωsledok sa zobraz√≠ tu</div>

<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.9.5/dist/leaflet.js"></script>
<script>
// --- PREP√çNAƒå RE≈ΩIMOV ---
const mode = document.getElementById("mode");
mode.onchange = () => calculateAll();

// --- MAPA ---
const map = L.map('map').setView([48.1486, 17.1077], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

let vehicleMarker, startMarker, endMarker, routeLayer;

// --- GPS VOZIDLA ---
function updateGPS(){
  const vehicleInput = document.getElementById("vehiclePos");
  if(!navigator.geolocation){
    vehicleInput.value = "GPS nie je podporovan√©";
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      vehicleInput.value = `${lat},${lon}`;
      if(vehicleMarker){
        vehicleMarker.setLatLng([lat,lon]);
      } else {
        vehicleMarker = L.marker([lat,lon], {draggable:true}).addTo(map).bindPopup("Vozidlo").openPopup();
        vehicleMarker.on('dragend', calculateAll);
      }
      map.setView([lat,lon],14);
      calculateAll();
    },
    err => { vehicleInput.value = "GPS zlyhalo, zadaj ruƒçne"; }
  );
}
updateGPS();

// --- VSTUPY ADRESY ---
const startInput = document.getElementById("startAddress");
const endInput = document.getElementById("endAddress");

// Klik na mapu na nastavenie markeru
map.on('click', function(e){
  const lat = e.latlng.lat;
  const lon = e.latlng.lng;
  if(!startMarker){
    startMarker = L.marker([lat,lon], {draggable:true}).addTo(map).bindPopup("N√°stup").openPopup();
    startMarker.on('dragend', calculateAll);
    startInput.value = `${lat.toFixed(6)},${lon.toFixed(6)}`;
  } else if(!endMarker){
    endMarker = L.marker([lat,lon], {draggable:true}).addTo(map).bindPopup("Cieƒæ").openPopup();
    endMarker.on('dragend', calculateAll);
    endInput.value = `${lat.toFixed(6)},${lon.toFixed(6)}`;
  }
  calculateAll();
});

// --- OSRM ---
async function getDistanceOSRM(lat1, lon1, lat2, lon2){
  const url = `https://router.project-osrm.org/route/v1/driving/${lon1},${lat1};${lon2},${lat2}?overview=false`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.routes && data.routes.length>0) return data.routes[0].distance/1000;
    return 0;
  } catch(e){ console.error(e); return 0; }
}

// --- HLAVN√Å FUNKCIA ---
async function calculateAll(){
  const vehicle = vehicleMarker ? vehicleMarker.getLatLng() : null;
  const start = startMarker ? startMarker.getLatLng() : null;
  const end = endMarker ? endMarker.getLatLng() : null;
  const extras = +document.getElementById("extras").value;

  if(!vehicle || !start || !end) return;

  // Vzdialenosti
  const kmToClient = await getDistanceOSRM(vehicle.lat, vehicle.lng, start.lat, start.lng);
  const kmWithClient = await getDistanceOSRM(start.lat, start.lng, end.lat, end.lng);

  // Sadzby pevne
  const rateToClient = 0.31;
  const rateWithClient = 0.85;

  const ridePrice = kmToClient*rateToClient + kmWithClient*rateWithClient + extras;
  const provizia = ridePrice*0.25;
  const dph = provizia*0.23;
  const totalCosts = provizia + dph;
  const profit = ridePrice - totalCosts;

  // Zobrazenie v√Ωsledku
  const result = document.getElementById("results");
  result.innerText = `N√°klady: ${ridePrice.toFixed(2)} ‚Ç¨ | Prov√≠zia: ${provizia.toFixed(2)} ‚Ç¨ | DPH: ${dph.toFixed(2)} ‚Ç¨ | Celkov√© n√°klady: ${totalCosts.toFixed(2)} ‚Ç¨ | Zisk: ${profit.toFixed(2)} ‚Ç¨`;
  result.className = "result " + (profit>=0?"green":"red");

  // Trasa na mape
  if(routeLayer) map.removeLayer(routeLayer);
  const coords = [
    [vehicle.lat, vehicle.lng],
    [start.lat, start.lng],
    [end.lat, end.lng]
  ];
  routeLayer = L.polyline(coords, {color:'blue'}).addTo(map);
  map.fitBounds(routeLayer.getBounds(), {padding:[20,20]});
}

// --- Automatick√Ω update pri zmene pr√≠platkov ---
document.getElementById("extras").oninput = calculateAll;
</script>

</body>
</html>
