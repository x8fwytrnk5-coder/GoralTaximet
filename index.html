<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taxi App ‚Äì Kompletn√° verzia</title>
<style>
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background:#f2f2f2; margin:0; padding:15px; }
h1 { text-align:center; }
.card { background:white; padding:15px; border-radius:12px; margin-bottom:15px; }
label { font-weight:600; display:block; margin-top:10px; }
input, select { width:100%; padding:10px; font-size:16px; margin-top:5px; }
.result { font-size:18px; margin-top:10px; font-weight:bold; }
.green { color:green; }
.red { color:red; }
.hidden { display:none; }
.suggestions { background:#fff; border:1px solid #ccc; border-radius:6px; max-height:120px; overflow-y:auto; position:absolute; z-index:1000; }
.suggestion-item { padding:5px; cursor:pointer; }
.suggestion-item:hover { background:#eee; }
</style>
</head>
<body>

<h1>üöï Taxi aplik√°cia ‚Äì Kompletn√° verzia</h1>

<div class="card">
  <label>Re≈æim aplik√°cie</label>
  <select id="mode">
    <option value="costs">Kalkulaƒçka n√°kladov</option>
    <option value="taximeter">Taxameter</option>
  </select>
</div>

<!-- KALKULAƒåKA N√ÅKLADOV -->
<div id="costs" class="card">
  <label>Poloha vozidla (GPS)</label>
  <input type="text" id="vehiclePos" readonly placeholder="Naƒç√≠tanie...">

  <label>N√°stup klienta</label>
  <input type="text" id="startAddress" placeholder="Zaƒçni p√≠sa≈• adresu">

  <label>Cieƒæ klienta</label>
  <input type="text" id="endAddress" placeholder="Zaƒçni p√≠sa≈• adresu">

  <label>Pr√≠platky</label>
  <input type="number" id="extrasCosts" value="0" step="0.1">
</div>

<!-- TAXAMETER -->
<div id="taximeter" class="card hidden">
  <label>Poloha vozidla (GPS)</label>
  <input type="text" id="vehiclePosT" readonly placeholder="Naƒç√≠tanie...">

  <label>N√°stup klienta</label>
  <input type="text" id="startAddressT" placeholder="Zaƒçni p√≠sa≈• adresu">

  <label>Cieƒæ klienta</label>
  <input type="text" id="endAddressT" placeholder="Zaƒçni p√≠sa≈• adresu">

  <label>Sadzba pristavenie</label>
  <input type="number" id="startRate" value="0.40" step="0.01">

  <label>Sadzba za 1 km</label>
  <input type="number" id="kmRate" value="0.85" step="0.01">

  <label>Pr√≠platky</label>
  <input type="number" id="extrasT" value="0" step="0.1">
</div>

<div id="results" class="card result">V√Ωsledok sa zobraz√≠ tu</div>

<script>
// --- PREP√çNAƒå RE≈ΩIMOV ---
const mode = document.getElementById("mode");
const costsDiv = document.getElementById("costs");
const taximeterDiv = document.getElementById("taximeter");
mode.onchange = () => {
  costsDiv.classList.toggle("hidden", mode.value !== "costs");
  taximeterDiv.classList.toggle("hidden", mode.value !== "taximeter");
  calculateAll();
};

// --- GPS ---
function updateGPS(inputId){
  const vehicleInput = document.getElementById(inputId);
  if(!navigator.geolocation){
    vehicleInput.value = "GPS nie je podporovan√©";
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      vehicleInput.value = `${lat},${lon}`;
      calculateAll();
    },
    err => { vehicleInput.value = "GPS zlyhalo, zadaj ruƒçne"; }
  );
}
updateGPS("vehiclePos");
updateGPS("vehiclePosT");

// --- AUTOCOMPLETE NOMINATIM ---
async function autocompleteAddress(inputId){
  const input = document.getElementById(inputId);
  input.addEventListener("input", async () => {
    const q = input.value;
    if(q.length<3) return;
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5&addressdetails=1`;
    const res = await fetch(url);
    const data = await res.json();
    // navrhn√∫≈• v konzole pre test
    console.log("Autocomplete", inputId, data.map(d=>d.display_name));
  });
}
autocompleteAddress("startAddress");
autocompleteAddress("endAddress");
autocompleteAddress("startAddressT");
autocompleteAddress("endAddressT");

// --- Hlavn√° funkcia ---
document.querySelectorAll("input").forEach(i => i.oninput = calculateAll);

async function calculateAll(){
  if(mode.value==="costs"){
    await calculateCostsGPS();
  } else {
    await calculateTaximeterOSRM();
  }
}

// --- OSRM ---
async function getDistanceOSRM(startLat, startLon, endLat, endLon){
  const url = `https://router.project-osrm.org/route/v1/driving/${startLon},${startLat};${endLon},${endLat}?overview=false`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(data.routes && data.routes.length>0) return data.routes[0].distance/1000;
    return 0;
  } catch(e){ console.error("OSRM error", e); return 0; }
}

// --- Kalkulaƒçka n√°kladov ---
async function calculateCostsGPS(){
  const vehicle = document.getElementById("vehiclePos").value.split(",");
  const start = document.getElementById("startAddress").value.split(",");
  const end = document.getElementById("endAddress").value.split(",");
  const extras = +document.getElementById("extrasCosts").value;

  if(vehicle.length<2 || start.length<2 || end.length<2) return;

  const kmToClient = await getDistanceOSRM(+vehicle[0], +vehicle[1], +start[0], +start[1]);
  const kmWithClient = await getDistanceOSRM(+start[0], +start[1], +end[0], +end[1]);

  const ridePrice = kmToClient*0.31 + kmWithClient*0.85 + extras;
  const provizia = ridePrice*0.25;
  const dph = provizia*0.23;
  const totalCosts = provizia + dph;
  const profit = ridePrice - totalCosts;

  const result = document.getElementById("results");
  result.innerText = `N√°klady: ${ridePrice.toFixed(2)} ‚Ç¨ | Prov√≠zia: ${provizia.toFixed(2)} ‚Ç¨ | DPH: ${dph.toFixed(2)} ‚Ç¨ | Celkov√© n√°klady: ${totalCosts.toFixed(2)} ‚Ç¨ | Zisk: ${profit.toFixed(2)} ‚Ç¨`;
  result.className = "result " + (profit>=0?"green":"red");
}

// --- Taxameter ---
async function calculateTaximeterOSRM(){
  const vehicle = document.getElementById("vehiclePosT").value.split(",");
  const start = document.getElementById("startAddressT").value.split(",");
  const end = document.getElementById("endAddressT").value.split(",");
  const startRate = +document.getElementById("startRate").value;
  const kmRate = +document.getElementById("kmRate").value;
  const extras = +document.getElementById("extrasT").value;

  if(vehicle.length<2 || start.length<2 || end.length<2) return;

  const kmToClient = await getDistanceOSRM(+vehicle[0], +vehicle[1], +start[0], +start[1]);
  const kmWithClient = await getDistanceOSRM(+start[0], +start[1], +end[0], +end[1]);

  const ridePrice = kmToClient*startRate + kmWithClient*kmRate + extras;
  const provizia = ridePrice*0.25;
  const dph = provizia*0.23;
  const totalCosts = provizia + dph;
  const profit = ridePrice - totalCosts;

  const result = document.getElementById("results");
  result.innerText = `Cena jazdy: ${ridePrice.toFixed(2)} ‚Ç¨ | Prov√≠zia: ${provizia.toFixed(2)} ‚Ç¨ | DPH: ${dph.toFixed(2)} ‚Ç¨ | Zisk: ${profit.toFixed(2)} ‚Ç¨`;
  result.className = "result " + (profit>=0?"green":"red");
}
</script>

</body>
</html>
